<% layout("/layouts/boilerplate") %>

<style>

/* ================= GLOBAL ================= */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  overflow-x: auto;
}

/* ================= NAVBAR ================= */
.navbar {
  background: #fff;
  padding: 0.6rem 1rem;
  border-bottom: 1px solid #eee;
}

.navbar-container {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  flex-wrap: wrap;
}

/* LEFT */
.nav-left {
  display: flex;
  align-items: center;
  gap: 15px;
}

.navbar-brand i {
  font-size: 1.6rem;
  color: #fe424d;
}

/* CENTER */
.search-wrapper {
  flex: 1;
  display: flex;
  justify-content: center;
  min-width: 0;
}

.search-form {
  display: flex;
  align-items: center;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 50px;
  padding: 0.3rem;
  width: 100%;
  max-width: 480px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.08);
}

.search-input {
  border: none;
  outline: none;
  box-shadow: none;
  padding-left: 1rem;
  width: 100%;
  min-width: 0;
}

.search-btn {
  background-color: #fe424d;
  color: white;
  border: none;
  border-radius: 50px;
  padding: 6px 16px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

/* RIGHT */
.nav-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.nav-link {
  text-decoration: none;
  font-weight: 500;
  color: #000;
}

.nav-link:hover {
  color: #fe424d;
}

.btn-link {
  background: none;
  border: none;
  padding: 0;
  cursor: pointer;
}

/* ================= MOBILE NAV ================= */
.mobile-menu {
  display: none;
  position: relative;
}

.mobile-menu button {
  background: #fe424d;
  color: #fff;
  border: none;
  border-radius: 50px;
  padding: 6px 14px;
  font-weight: 500;
  cursor: pointer;
}

.mobile-menu .dropdown {
  display: none;
  position: absolute;
  top: 42px;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 12px;
  min-width: 160px;
  flex-direction: column;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  z-index: 10;
}

.mobile-menu .dropdown a,
.mobile-menu .dropdown form button {
  padding: 8px 12px;
  text-align: left;
  width: 100%;
  border: none;
  background: none;
  cursor: pointer;
  font-weight: 500;
}

.mobile-menu .dropdown a:hover,
.mobile-menu .dropdown form button:hover {
  background: #f6f6f6;
}

/* ================= FILTER BAR ================= */
#filters {
  display: flex;
  flex-wrap: nowrap;
  gap: 1.5rem;
  padding-bottom: 10px;
  align-items: center;
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: none;
}

#filters::-webkit-scrollbar {
  display: none;
}

.filter {
  text-align: center;
  opacity: 0.7;
  transition: 0.3s ease;
  min-width: 70px;
  flex-shrink: 0;
}

.filter:hover {
  opacity: 1;
  cursor: pointer;
  transform: scale(1.1);
}

.filter p {
  font-size: 0.75rem;
  margin-top: 5px;
}

.active-filter {
  opacity: 1;
  transform: scale(1.1);
  border-bottom: 2px solid #fe424d;
}

.tax-toggle {
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 8px 14px;
  display: flex;
  align-items: center;
  white-space: nowrap;
  background: white;
  margin-left: auto;
}

/* ================= LISTING CARDS ================= */
.listing-card {
  border: none;
  border-radius: 15px;
  overflow: hidden;
  transition: 0.25s ease;
}

.listing-card:hover {
  transform: translateY(-4px);
}

.listing-card img {
  height: 20rem;
  object-fit: cover;
  width: 100%;
  border-radius: 15px;
}

.tax-info {
  display: none;
}

/* ================= RESPONSIVE ================= */
@media (max-width: 768px) {
  .nav-left,
  .nav-right {
    display: none;
  }
  .mobile-menu {
    display: block;
  }
}
</style>

<!-- ================= NAVBAR ================= -->
<nav class="navbar sticky-top">
  <div class="container-fluid navbar-container">

    <!-- LEFT (desktop only) -->
    <div class="nav-left">
      <a class="navbar-brand" href="/listings"><i class="fa-regular fa-compass"></i></a>
      <a class="nav-link" href="/listings">Explore</a>
    </div>

    <!-- CENTER SEARCH -->
    <div class="search-wrapper">
      <form class="search-form" action="/listings" method="GET">
        <input class="search-input" type="search" name="search" placeholder="Search destinations" value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"/>
        <button class="search-btn" type="submit"><i class="fa-solid fa-magnifying-glass"></i><span>Search</span></button>
      </form>
    </div>

    <!-- RIGHT (desktop only) -->
    <div class="nav-right">
      <a class="nav-link" href="/listings/new">Airbnb your home</a>
      <% if(!currentUser){ %>
        <a class="nav-link" href="/signup"><b>Signup</b></a>
        <a class="nav-link" href="/login"><b>Login</b></a>
      <% } else { %>
        <form action="/logout" method="POST" class="m-0">
          <button type="submit" class="btn-link nav-link"><b>Logout</b></button>
        </form>
      <% } %>
    </div>

    <!-- MOBILE BUTTON -->
    <div class="mobile-menu">
      <button id="mobileMenuBtn">â˜° Menu</button>
      <div class="dropdown" id="mobileDropdown">
        <a href="/listings/new">Airbnb your home</a>
        <% if(!currentUser){ %>
          <a href="/signup">Signup</a>
          <a href="/login">Login</a>
        <% } else { %>
          <form action="/logout" method="POST">
            <button type="submit">Logout</button>
          </form>
        <% } %>
      </div>
    </div>

  </div>
</nav>

<script>
const mobileBtn = document.getElementById("mobileMenuBtn");
const mobileDropdown = document.getElementById("mobileDropdown");

mobileBtn.addEventListener("click", () => {
  if(mobileDropdown.style.display === "flex"){
    mobileDropdown.style.display = "none";
  } else {
    mobileDropdown.style.display = "flex";
    mobileDropdown.style.flexDirection = "column";
  }
});
</script>

<!-- ================= FILTER BAR ================= -->
<div id="filters" class="mb-3">
  <% const categories = ["Trending","Rooms","Iconic cities","Mountains","Castles","Amazing Pools","Farm","Camping","Arctic","Hiking","Beach"]; %>
  <% categories.forEach(category => { %>
    <a href="/listings?category=<%= encodeURIComponent(category) %><%= searchQuery ? '&search=' + encodeURIComponent(searchQuery) : '' %>" class="text-decoration-none text-dark">
      <div class="filter <%= selectedCategory === category ? 'active-filter' : '' %>">
        <i class="fa-solid fa-<%= category==='Trending'?'fire': category==='Rooms'?'bed': category==='Iconic cities'?'mountain-city': category==='Mountains'?'mountain': category==='Castles'?'fort-awesome': category==='Amazing Pools'?'person-swimming': category==='Farm'?'building-wheat': category==='Camping'?'tent': category==='Arctic'?'igloo': category==='Hiking'?'person-hiking':'umbrella-beach' %>"></i>
        <p><%= category %></p>
      </div>
    </a>
  <% }) %>

  <div class="tax-toggle">
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="switchCheckDefault">
      <label class="form-check-label">Display total before taxes</label>
    </div>
  </div>
</div>

<!-- ================= LISTINGS ================= -->
<div class="row g-4 row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4">
  <% if(allListings.length === 0){ %>
    <h4>No listings found.</h4>
  <% } %>
  <% allListings.forEach(listing => { %>
    <div class="col">
      <a href="/listings/<%= listing._id %>" class="text-decoration-none text-dark">
        <div class="card listing-card h-100">
          <img src="<%= listing.image?.url || '/images/default.jpg' %>" alt="<%= listing.title %>">
          <div class="card-body">
            <p class="card-text mb-0">
              <b><%= listing.title %></b><br>
              &#8377; <%= listing.price.toLocaleString("en-IN") %> / night
              <span class="tax-info"> +18% GST</span>
            </p>
          </div>
        </div>
      </a>
    </div>
  <% }) %>
</div>

<script>
const taxSwitch = document.getElementById("switchCheckDefault");
taxSwitch.addEventListener("click", () => {
  const taxInfo = document.getElementsByClassName("tax-info");
  for(let info of taxInfo){
    info.style.display = taxSwitch.checked ? "inline" : "none";
  }
});
</script>
