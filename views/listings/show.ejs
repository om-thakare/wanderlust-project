<% layout("layouts/boilerplate") %> âœ…


<style>

/* ================= GLOBAL ================= */
html, body {
  overflow-x: hidden;
  scroll-behavior: smooth;
}

/* ================= IMAGE ================= */
.show-img {
  height: 420px;       /* fixed height for all screens */
  object-fit: cover;
  border-radius: 12px;
  width: 100%;
}

/* ================= MAP ================= */
#map {
  height: 350px;
  width: 100%;
  border-radius: 12px;
}

/* Sticky map (desktop only) */
.map-card {
  width: 100%;
}
@media (min-width: 992px) {
  .map-card {
    position: sticky;
    top: 100px;
  }
}

/* ================= STAR INPUT ================= */
.star-rating {
  direction: rtl;
  display: inline-flex;
  gap: 5px;
}
.star-rating input {
  display: none;
}
.star-rating label {
  font-size: 28px;
  color: #ddd;
  cursor: pointer;
  transition: 0.2s;
}
.star-rating label:hover,
.star-rating label:hover ~ label,
.star-rating input:checked ~ label {
  color: #ff385c;
}

/* ================= REVIEW STARS ================= */
.star {
  font-size: 18px;
  color: #ddd;
}
.star.filled {
  color: #ff385c;
}
.star.half {
  background: linear-gradient(90deg,#ff385c 50%,#ddd 50%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* ================= RATING SUMMARY ================= */
.rating-summary {
  background: #fff;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 20px;
}
.rating-average {
  font-size: 26px;
  font-weight: 600;
}
.rating-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}
.rating-bar {
  flex: 1;
  height: 6px;
  background: #eee;
  border-radius: 10px;
  overflow: hidden;
}
.rating-fill {
  height: 100%;
  background: #ff385c;
}

/* ================= CARD ================= */
.card.show-card {
  border-radius: 12px;
}

/* ================= RESPONSIVE FIX ================= */
@media (max-width: 991px) {
  .show-img {
    height: 250px;    /* scale images smaller for mobile */
  }
  .col-12.col-lg-8,
  .col-12.col-lg-4 {
    flex: 0 0 100%;
    max-width: 100%;
  }
  .map-card {
    margin-top: 20px;
  }
}
</style>

<div class="container mt-4">
  <div class="row g-4">

    <!-- ================= LEFT SIDE ================= -->
    <div class="col-12 col-lg-8">

      <h3 class="fw-bold"><%= listing.title %></h3>

      <% 
        let total = 0;
        listing.reviews.forEach(r => total += r.rating);
        let avgRating = listing.reviews.length 
          ? (total / listing.reviews.length) 
          : 0;
      %>

      <!-- Average Rating -->
      <div class="mb-2">
        <span class="rating-average"><%= avgRating.toFixed(1) %></span>

        <% for(let i=1;i<=5;i++){ %>
          <% if(i <= Math.floor(avgRating)){ %>
            <span class="star filled">&#9733;</span>
          <% } else if(i - avgRating < 1 && i - avgRating > 0){ %>
            <span class="star half">&#9733;</span>
          <% } else { %>
            <span class="star">&#9733;</span>
          <% } %>
        <% } %>

        <span class="text-muted">
          (<%= listing.reviews.length %> reviews)
        </span>
      </div>

      <!-- Listing Card -->
      <div class="card border-0 shadow-sm mt-3 show-card">
        <img 
          src="<%= listing.image?.url || '/images/default.jpg' %>"
          class="card-img-top show-img"
          alt="<%= listing.title %>"
        >

        <div class="card-body">
          <p class="text-muted mb-1">
            Owned by <b><%= listing.owner?.username || "Unknown" %></b>
          </p>

          <h5 class="fw-bold">&#8377;<%= listing.price.toLocaleString("en-IN") %></h5>
          <p class="text-muted"><%= listing.location %>, <%= listing.country %></p>

          <hr>
          <p><%= listing.description %></p>
        </div>
      </div>

      <!-- Owner Buttons -->
      <% if (currUser && listing.owner &&
            currUser._id.toString() === listing.owner._id.toString()) { %>
        <div class="mt-3">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark">Edit</a>
          <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
            <button class="btn btn-danger">Delete</button>
          </form>
        </div>
      <% } %>

      <hr class="mt-4">

      <!-- Review Form -->
      <% if (currUser) { %>
      <h4>Leave a Review</h4>
      <form action="/listings/<%= listing._id %>/reviews" method="POST" class="needs-validation" novalidate>
        <div class="mb-3">
          <label class="form-label">Rating</label>
          <div class="star-rating">
            <% for(let i=5;i>=1;i--){ %>
              <input type="radio" name="review[rating]" value="<%= i %>" id="star<%= i %>">
              <label for="star<%= i %>">&#9733;</label>
            <% } %>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Comments</label>
          <textarea name="review[comment]" rows="4" class="form-control" required></textarea>
          <div class="invalid-feedback">Please add some comments.</div>
        </div>

        <button class="btn btn-outline-dark">Submit</button>
      </form>
      <hr>
      <% } %>

      <!-- Rating Summary Bars -->
      <div class="rating-summary">
        <% for(let star=5; star>=1; star--){ 
            let count = listing.reviews.filter(r => r.rating === star).length;
            let percent = listing.reviews.length
              ? (count / listing.reviews.length) * 100
              : 0;
        %>
        <div class="rating-row">
          <span><%= star %></span>
          <span class="star filled">&#9733;</span>
          <div class="rating-bar">
            <div class="rating-fill" style="width:<%= percent %>%"></div>
          </div>
          <span class="text-muted"><%= count %></span>
        </div>
        <% } %>
      </div>

      <!-- All Reviews -->
      <% if (listing.reviews.length > 0) { %>
      <h4>All Reviews</h4>
      <div class="row">
        <% listing.reviews.forEach(review => { %>
          <div class="col-12 col-md-6 mb-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5><%= review.author?.username || "Anonymous" %></h5>
                <p>
                  <% for(let i=1;i<=5;i++){ %>
                    <% if(i <= review.rating){ %>
                      <span class="star filled">&#9733;</span>
                    <% } else { %>
                      <span class="star">&#9733;</span>
                    <% } %>
                  <% } %>
                </p>
                <p><%= review.comment %></p>
                <% if (currUser && review.author &&
                      currUser._id.toString() === review.author._id.toString()) { %>
                  <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                    <button class="btn btn-sm btn-dark">Delete</button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
      <% } %>

    </div>

    <!-- ================= RIGHT SIDE MAP ================= -->
    <div class="col-12 col-lg-4">
      <div class="map-card p-3 shadow-sm bg-white rounded-4">
        <h5>Where you'll be</h5>
        <div id="map"></div>
      </div>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const listing = <%- JSON.stringify(listing) %>;
  if (!listing.geometry || !listing.geometry.coordinates) return;

  const [lng, lat] = listing.geometry.coordinates;

  const map = L.map("map").setView([lat, lng], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
    maxZoom: 19
  }).addTo(map);

  L.marker([lat, lng])
    .addTo(map)
    .bindPopup(`<b>${listing.title}</b><br>${listing.location}`)
    .openPopup();
});
</script>
