
<% layout("/layouts/boilerplate") %>

<div class="container mt-3">

  <div class="row">

    <!-- ================= LEFT SIDE (LISTING DETAILS) ================= -->
    <div class="col-12 col-lg-8">

      <!-- TITLE -->
      <h3 class="fw-bold"><%= listing.title %></h3>

      <!-- LISTING CARD -->
      <div class="card border-0 shadow-sm mt-3">

        <img 
          src="<%= listing.image?.url || '/images/default.jpg' %>"
          class="card-img-top show-img"
          alt="<%= listing.title %>"
        >

        <div class="card-body">

          <p class="text-muted mb-1">
            Owned by 
            <b><%= listing.owner?.username || "Unknown" %></b>
          </p>

          <h5 class="fw-bold">
            &#8377;<%= listing.price.toLocaleString("en-IN") %>
          </h5>

          <p class="text-muted">
            <%= listing.location %>, <%= listing.country %>
          </p>

          <hr>

          <p><%= listing.description %></p>

        </div>
      </div>

      <!-- OWNER BUTTONS -->
      <% if (currUser && listing.owner &&
            currUser._id.toString() === listing.owner._id.toString()) { %>

        <div class="mt-3">
          <a href="/listings/<%= listing._id %>/edit" 
             class="btn btn-dark">Edit</a>

          <form action="/listings/<%= listing._id %>?_method=DELETE"
                method="POST"
                class="d-inline">
            <button class="btn btn-danger">Delete</button>
          </form>
        </div>

      <% } %>

      <hr class="mt-4">

      <!-- ================= REVIEW FORM ================= -->
      <% if (currUser) { %>

        <h4>Leave a Review</h4>

        <form action="/listings/<%= listing._id %>/reviews"
              method="POST"
              class="needs-validation"
              novalidate>

          <fieldset class="mb-3">
            <legend>Star Rating:</legend>

            <% for(let i=1; i<=5; i++) { %>
              <input type="radio"
                     id="rate<%= i %>"
                     name="review[rating]"
                     value="<%= i %>">
              <label for="rate<%= i %>"><%= i %> star</label>
            <% } %>
          </fieldset>

          <div class="mb-3">
            <label class="form-label">Comments</label>
            <textarea name="review[comment]"
                      rows="4"
                      class="form-control"
                      required></textarea>

            <div class="invalid-feedback">
              Please add some comments.
            </div>
          </div>

          <button class="btn btn-outline-dark">
            Submit
          </button>
        </form>

        <hr>

      <% } %>

      <!-- ================= ALL REVIEWS ================= -->
      <% if (listing.reviews.length > 0) { %>

        <h4>All Reviews</h4>

        <div class="row">
          <% listing.reviews.forEach(review => { %>

            <div class="col-12 col-md-6 mb-3">
              <div class="card shadow-sm h-100">
                <div class="card-body">

                  <h5>
                    <%= review.author?.username || "Anonymous" %>
                  </h5>

                  <p>Rating: <%= review.rating %> / 5</p>
                  <p><%= review.comment %></p>

                  <% if (currUser && review.author &&
                        currUser._id.toString() === review.author._id.toString()) { %>

                    <form method="POST"
                          action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                      <button class="btn btn-sm btn-dark">
                        Delete
                      </button>
                    </form>

                  <% } %>

                </div>
              </div>
            </div>

          <% }) %>
        </div>

      <% } %>

    </div>


    <!-- ================= RIGHT SIDE MAP ================= -->
    <div class="col-12 col-lg-4 mt-4 mt-lg-0">

      <div class="map-card p-3 shadow-sm">
        <h5>Where you'll be</h5>
        <div id="map"></div>
      </div>

    </div>

  </div>
</div>


<!-- ================= MAP SCRIPT ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const listing = <%- JSON.stringify(listing) %>;

  if (!listing.geometry || !listing.geometry.coordinates) {
    console.log("No coordinates found");
    return;
  }

  const [lng, lat] = listing.geometry.coordinates;

  const map = L.map("map").setView([lat, lng], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap contributors",
    maxZoom: 19
  }).addTo(map);

  const marker = L.marker([lat, lng]).addTo(map);

  marker.bindPopup(
    `<b>${listing.title}</b><br>${listing.location}`
  ).openPopup();

});
</script>
